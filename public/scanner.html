<!DOCTYPE html>
<html>
  <link rel="stylesheet" href="scanner.css">
  <link rel="icon" href="/images/logo-portocaliu-full.png" />
  <link rel="apple-touch-icon" href="/images/logo-portocaliu-full.png" />
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script> 
  <script src="libs/inflate.min.js"></script>


<div class="landscape">
  <h1 class="back-button font-face-halvar-regular" style="color: white;">Feature available only in portrait mode!</h1>
</div>
<body>
  <div class="header">
    <div class="header-content">
      <!-- <img src="/images/logo-viar.jpg"/> -->
      <h1 class="font-face-halvar-regular" style="font-size: 5vh; font-weight: 700">VIVO Burgers</h1>
      <button class="back-button font-face-halvar-regular" style="font-size: 2.5vh !important; font-weight: 700;"><a href="/">BACK</a></button>
    </div>
  </div>
  <div name="body" class="body" style="margin : auto; overflow: hidden; display: block;" id="slider">


    <div id="preloader" style="height: 90vh; width: auto; background-color: #ffff; visibility: visible; top: 0vh; left: 0vw; ">
      <img src="/images/logo-portocaliu-full.png" class="rotate" width="100" height="100" loading="lazy" />
      <div class="loading-text">
        <h2 style="display: block; color: black; font-size: 8vw;" class="font-face-halvar-regular">Loading your model...</h2>
      </div>
      <div id="swipeAnimation">
        <img src="/images/swipe-helper.gif" class="gif" id="gif"/>
        <div class="gif-text">
          <h3 style="display: block; color: black; font-size: 20px !important;" class="font-face-halvar-regular">Swipe to navigate the menu.</h3>
        </div>
      </div>
    </div>
    <div id="markerOverlay" style="height: 100%; width: 100%;">
      <div id="markerHelper">
        <div class="markerHelperText">
          <h3 style="display: block; color: black; font-size: 3vh !important; text-align: center;" class="font-face-halvar-regular">Scan the marker in order to see the item!</h3> 
        </div>
      </div>
    </div>
    


    <a-scene embedded arjs light="defaultLightsEnabled: false">
      <a-marker preset='custom' type='pattern' url='pattern-pp.patt'>
          <a-entity
          id="model"
          position="0 0 0"
          scale="20 20 20"
          material="shader: flat"
          animation="property: rotation; dur: 15000; to: 0 360 0; easing: linear; loop: true"></a-entity>
          <a-entity light="type: ambient; color: #FFF; intensity: 1"></a-entity>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    

    <div class="banner" id="banner">
      
      <div class="content" id="content">
        <p style="font-size: 4vw !important; font-weight: 600; margin-bottom: 0vh;" class="font-face-halvar-regular" id="description"></p>
        <p style="font-size: 5vw !important; font-weight: 600; margin-top: 0.4vh;" class="font-face-halvar-regular" id="price">price</p>
      </div>
      <button type="button" class="collapsible font-face-halvar-regular" id="collapsible" style="font-size: 7vw !important; font-weight: 900;">Open Collapsible</button>
    </div>
    <script>
      var coll = document.getElementsByClassName("collapsible");
      var i;
      
      for (i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var content = this.previousElementSibling;
          var banner = document.getElementById("banner");
          if (content.style.maxHeight){
            content.style.maxHeight = null;
          } else {
            content.style.maxHeight = content.scrollHeight + "px";
          } 
        });
      }
      </script>







    <script>

    window.addEventListener('markerFound', () => {
        document.getElementById("markerHelper").setAttribute("style", "height: 0vh; width: 0vh");
        document.getElementById("markerOverlay").setAttribute("style", "visibility: hidden !important");
        // console.log("marker found");
      });
    
    window.addEventListener('markerLost', () => {
      setTimeout(function(){ loaded = true; }, 200);
      document.getElementById("markerHelper").setAttribute("style", "height: 80vh; width: 80vh");
          document.getElementById("markerOverlay").setAttribute("style", "visibility: hidden !important");
          // console.log("marker lost");
        });

      var modelID;
      var model;
      var modelName;
      var modelDescription;
      var modelPrice;
      var loaded = false;

      async function setParams(id, mdl, name, description, price)
      {
        this.modelID = id;
        this.model = mdl;
        this.modelName = name;
        this.modelDescription = description;
        this.modelPrice = price;
        console.log(modelName);
      }


      
      const params = new URLSearchParams(document.location.search);
      var id = parseInt(params.get("item"));
      response =  fetch('https://test.viar-eu.com/api/requests/model/get_model.php?ID='+id.toString())
      .then(response => response.json())
      .then(data => setParams(data.ID, data.model, data.name, data.description, data.price)
      .then(loadObj(this.model, this.modelDescription, this.modelPrice))
      .then(
      fetch('https://test.viar-eu.com/api/requests/request/new_request.php', {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          client: 'demoFeature',
          item: this.modelName
        })
      })));


      function loadObj(objModel, description, price)
      {
        loaded = false;
        var script = document.getElementById("model").setAttribute('obj-model',"obj: url(/models/"+objModel.toString()+"/"+objModel.toString()+".obj); mtl: url(/models/"+objModel.toString()+"/"+objModel.toString()+".mtl)");
        const loader = new THREE.OBJLoader();
        loader.load("/models/"+objModel.toString()+"/"+objModel.toString()+".obj", function()
        {
          document.getElementById('collapsible').innerHTML = this.modelName;
          document.getElementById('description').innerHTML = this.modelDescription;
          setTimeout(function(){ loaded = true; }, 300);
          document.getElementById('price').innerHTML = "Pret: " + this.modelPrice;
          document.getElementById("preloader").setAttribute("style", "visibility: hidden; height: 0%;");
          document.getElementById("banner").setAttribute("style", "visibility: visible");
        })
      }


      let touchstartX = 0
      let touchendX = 0

      const slider = document.getElementById('slider');
      const totalNr = parseInt(params.get("outOf"));


      function handleGesture() {
        if (touchendX - touchstartX < -70 && id+1<=totalNr && loaded){
          document.getElementById("banner").setAttribute("style", "visibility: hidden");
          console.log("swiped left");
          document.getElementById("preloader").setAttribute("style", "visibility: visible; height: 90vh; background-color: rgba(255,255,255,0.5)");
          id++;
          response =  fetch('https://test.viar-eu.com/api/requests/model/get_model.php?ID='+id.toString())
          .then(response => response.json())
          .then(data => setParams(data.ID, data.model, data.name, data.description, data.price)
          .then(loadObj(this.model, this.modelDescription, this.modelPrice))
          .then(
          fetch('https://test.viar-eu.com/api/requests/request/new_request.php', {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              client: 'demoFeature',
              item: this.modelName
            })
          })));
        }
        if (touchendX - touchstartX > 70 && id-1>0 && loaded){
          document.getElementById("banner").setAttribute("style", "visibility: hidden");
          console.log("swiped right");
          document.getElementById("preloader").setAttribute("style", "visibility: visible; height: 90vh; background-color: rgba(255,255,255,0.5)");
          id--;
          response =  fetch('https://test.viar-eu.com/api/requests/model/get_model.php?ID='+id.toString())
          .then(response => response.json())
          .then(data => setParams(data.ID, data.model, data.name, data.description, data.price)
          .then(loadObj(this.model, this.modelDescription, this.modelPrice))
          .then(
          fetch('https://test.viar-eu.com/api/requests/request/new_request.php', {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              client: 'demoFeature',
              item: this.modelName
            })
          })));
        }
      }

      slider.addEventListener('touchstart', e => {
        touchstartX = e.changedTouches[0].screenX
      })

      slider.addEventListener('touchend', e => {
        touchendX = e.changedTouches[0].screenX
        handleGesture()
      })

      function detectBrowser() { 
        console.log(navigator.userAgent.toString());
        if(navigator.userAgent.indexOf("Chrome") != -1 ) {
            return 'Chrome';
        } else if(navigator.userAgent.indexOf("Safari") != -1) {
            document.getElementById("gif").classList.toggle("gif-ios");
            document.getElementById("content").classList.toggle("content-ios");
            document.getElementById("collapsible").classList.toggle("collapsible-ios");
            return 'Safari';
        } else if(navigator.userAgent.indexOf("Firefox") != -1 ){
            alert("Best viewed on Google Chrome or Safari!");
            return 'Firefox';
        } else if((navigator.userAgent.indexOf("MSIE") != -1 ) || (!!document.documentMode == true )) {
            alert("Best viewed on Google Chrome or Safari!");
            return 'IE';//crap
        } else {
            alert("Best viewed on Google Chrome or Safari!");
            return 'Unknown';
        }
      } 
      // console.log(detectBrowser());
    
      
    </script>
  </div>
</body>
</html>
