<!DOCTYPE html>
<html>
  <link rel="stylesheet" href="scanner.css">
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script> 
  <script src="libs/inflate.min.js"></script>

  <div class="header">
    <div class="header-content">
      <!-- <img src="/images/logo-viar.jpg"/> -->
      <h1 class="futura-bold">ViAR</h1>
      <button class="back-button"><a href="/">BACK</a></button>
    </div>
  </div>
  <body name="body" style="margin : auto; overflow: hidden; display: block;" id="slider">


    <div id="preloader" style="height: 90vh; width: auto; background-color: #ffff; visibility: visible; top: 0vh; left: 0vw; ">
      <img src="/images/logo-viar.jpg" class="rotate" width="100" height="100" loading="lazy" />
      <div class="loading-text">
        <h2 style="display: block; color: black; font-family:'PT Sans'; font-weight: normal;">Loading your model...</h2>
      </div>
      <div id="swipeAnimation">
        <img src="/images/swipe-helper.gif" class="gif"/>
        <div class="gif-text">
          <h3 style="display: block; color: black; font-family:'PT Sans'; font-weight: normal;">Swipe to navigate the menu.</h3>
        </div>
      </div>
    </div>


    <a-scene embedded arjs light="defaultLightsEnabled: false">
      <a-marker preset='custom' type='pattern' url='pattern-pp.patt'>
          <a-entity
          id="model"
          position="0 0 -0.5"
          scale="20 20 20"
          material="shader: flat"
          animation="property: rotation; dur: 15000; to: 0 360 0; easing: linear; loop: true"></a-entity>
          <a-entity light="type: ambient; color: #FFF; intensity: 1.5"></a-entity>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    

    <div class="banner" id="banner">
      
      <div class="content">
        <p style="font-family: 'PT Sans', sans-serif" id="description">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        <p style="font-family: 'PT Sans', sans-serif" id="price">price</p>
      </div>
      <button type="button" class="collapsible" id="itemName">Open Collapsible</button>
    </div>
    <script>
      var coll = document.getElementsByClassName("collapsible");
      var i;
      
      for (i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var content = this.previousElementSibling;
          var banner = document.getElementById("banner");
          if (content.style.maxHeight){
            content.style.maxHeight = null;
          } else {
            content.style.maxHeight = content.scrollHeight + "px";
          } 
        });
      }
      </script>







    <script>

      var modelID;
      var model;
      var modelName;
      var modelDescription;
      var modelPrice;

      async function setParams(id, mdl, name, description, price)
      {
        this.modelID = id;
        this.model = mdl;
        this.modelName = name;
        this.modelDescription = description;
        this.modelPrice = price;
        console.log(modelName);
      }


      
      const params = new URLSearchParams(document.location.search);
      var id = parseInt(params.get("item"));
      response =  fetch('https://test.viar-eu.com/api/api/model/get_model.php?ID='+id.toString())
      .then(response => response.json())
      .then(data => setParams(data.ID, data.model, data.name, data.description, data.price)
      .then(loadObj(this.model, this.modelDescription, this.modelPrice))
      .then(
      fetch('https://test.viar-eu.com/api/api/request/new_request.php', {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          client: 'TestSite',
          item: this.modelName
        })
      })));


      function loadObj(objModel, description, price)
      {
        var script = document.getElementById("model").setAttribute('obj-model',"obj: url(/models/"+objModel.toString()+"/"+objModel.toString()+".obj); mtl: url(/models/"+objModel.toString()+"/"+objModel.toString()+".mtl)");
        const loader = new THREE.OBJLoader();
        loader.load("/models/"+objModel.toString()+"/"+objModel.toString()+".obj", function()
        {
          document.getElementById('itemName').innerHTML = this.modelName;
          document.getElementById('description').innerHTML = this.modelDescription;
          document.getElementById('price').innerHTML = "Pret: " + this.modelPrice;
          document.getElementById("preloader").setAttribute("style", "visibility: hidden; height: 0%;");
          document.getElementById("banner").setAttribute("style", "visibility: visible");
        })
      }


      let touchstartX = 0
      let touchendX = 0

      const slider = document.getElementById('slider');
      const totalNr = parseInt(params.get("outOf"));


      function handleGesture() {
        if (touchendX - touchstartX < -70 && id+1<=totalNr){
          document.getElementById("banner").setAttribute("style", "visibility: hidden");
          console.log("swiped left");
          document.getElementById("preloader").setAttribute("style", "visibility: visible; height: 90vh; background-color: rgba(255,255,255,0.5)");
          id++;
          response =  fetch('https://test.viar-eu.com/api/api/model/get_model.php?ID='+id.toString())
          .then(response => response.json())
          .then(data => setParams(data.ID, data.model, data.name, data.description, data.price)
          .then(loadObj(this.model, this.modelDescription, this.modelPrice))
          .then(
          fetch('https://test.viar-eu.com/api/api/request/new_request.php', {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              client: 'TestSite',
              item: this.modelName
            })
          })));
        }
        if (touchendX - touchstartX > 70 && id-1>0){
          document.getElementById("banner").setAttribute("style", "visibility: hidden");
          console.log("swiped right");
          document.getElementById("preloader").setAttribute("style", "visibility: visible; height: 90vh; background-color: rgba(255,255,255,0.5)");
          id--;
          response =  fetch('https://test.viar-eu.com/api/api/model/get_model.php?ID='+id.toString())
          .then(response => response.json())
          .then(data => setParams(data.ID, data.model, data.name, data.description, data.price)
          .then(loadObj(this.model, this.modelDescription, this.modelPrice))
          .then(
          fetch('https://test.viar-eu.com/api/api/request/new_request.php', {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              client: 'TestSite',
              item: this.modelName
            })
          })));
        }
      }

      slider.addEventListener('touchstart', e => {
        touchstartX = e.changedTouches[0].screenX
      })

      slider.addEventListener('touchend', e => {
        touchendX = e.changedTouches[0].screenX
        handleGesture()
      })
    </script>
  </body>
</html>
